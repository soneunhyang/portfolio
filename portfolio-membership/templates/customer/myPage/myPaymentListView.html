<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{customer/layout/myPageDefault}">


	<!-- head 삽입공간 -->
	
	<head>
	</head>
	
	<th:block layout:fragment="jsFile">
		<script src="https://js.tosspayments.com/v2/standard"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	</th:block>
	
	
	<th:block layout:fragment="jsScript">
		<script type="text/javascript">
			$(function(){
				$('.modifyCardBtn').click(function(){
				    const customerKey = document.getElementById("custId").value;
	
				    const card = $(this).closest(".product-cart-wrap");
				    const contractInput = card.find(".contractNo");
				    const rentalContractNo = contractInput ? contractInput.val() : "";

				    
				    const tossPayments = TossPayments("test_ck_GePWvyJnrKvyQXaXB74bVgLzN97E");
				    const payment = tossPayments.payment({ customerKey });
	
				    payment.requestBillingAuth({
		     			method: "CARD",
			     		successUrl: window.location.origin + "/customer/payment/modifyBilling/success?rentalContractNo=" + rentalContractNo,
				     	failUrl: window.location.origin + "/customer/payment/modifyBilling/fail"
				    }).catch(function (error) {
			    		if (error.code === "USER_CANCEL") {
	              			console.log('사용자가 취소했습니다.');
			            } else {
		            		console.log(error.message);
			            }
		            });
				});
				
			
				
				$('.cancelBtn').click(function(){
					 const card = $(this).closest(".product-cart-wrap");
		             const delProgress = card.find(".delProgress");
		             const delStatus = delProgress ? delProgress.text().trim() : "";
		        	
		        	if(delStatus === "배송중" || delStatus === "배송완료") {
		        		Swal.fire("취소 불가", "배송이 이미 시작된 상품은 주문을 취소할 수 없습니다.", "info");
		        		return;
		        	} else if(delStatus === "주문취소") {
		        		Swal.fire("취소 불가", "주문이 취소된 상품입니다.", "info");
		        		return
		        	}
		        	
		            const orderId = this.getAttribute('data-order-id');
		            const paymentCompletedNo = this.getAttribute('data-payment-completed-no');

		            if (!orderId) {
		                Swal.fire("오류", "orderId가 없습니다.", "error");
		                return;
		            }

		            const swalWithBootstrapButtons = Swal.mixin({
		                customClass: {
		                    actions: 'w-50 justify-content-around',
		                    confirmButton: "btn btn-success",
		                    cancelButton: "btn btn-danger"
		                },
		                buttonsStyling: false
		            });

		            swalWithBootstrapButtons.fire({
		                title: "주문취소",
		                text: "정말로 주문을 취소하시겠습니까?",
		                icon: "warning",
		                showCancelButton: true,
		                confirmButtonText: "취소 진행",
		                cancelButtonText: "아니요",
		                reverseButtons: true
		            }).then((result) => {
		                if (result.isConfirmed) {
		                    fetch('/customer/payment/cancel', {
		                        method: 'POST',
		                        headers: {
		                            'Content-Type': 'application/x-www-form-urlencoded'
		                        },
		                        body: new URLSearchParams({ orderId: orderId,
		                        	 						paymentCompletedNo: paymentCompletedNo
		                        	 					  })
		                    })
		                    .then(async res => {
							    const text = await res.text();
							
							    if (res.ok) {
							        swalWithBootstrapButtons.fire({
							            title: "처리 완료",
							            text: text,
							            icon: "success"
							        }).then(() => {
							            location.reload();
							        });
							    } else {
							        swalWithBootstrapButtons.fire({
							            title: "처리 실패",
							            text: text,
							            icon: "error"
							        });
							    }
							})
		                    .catch(err => {
		                        console.error("에러:", err);
		                        Swal.fire("오류", "주문취소 중 오류가 발생했습니다.", "error");
		                    });
		                } else if (result.dismiss === Swal.DismissReason.cancel) {
		                    swalWithBootstrapButtons.fire({
		                        title: "중단됨",
		                        text: "주문 취소가 중단되었습니다.",
		                        icon: "info"
		                    });
		                }
		            });
				});
				
			    
				$('.refundBtn').click(function() {

					const card = $(this).closest(".product-cart-wrap");
					const delProgress = card.find(".delProgress");
					const delStatus = delProgress ? delProgress.text().trim() : "";

					if(delStatus === "배송완료") {
						
						const refundBtn = $(this);
	
						const orderId = $(this).attr('data-order-id');
						const paymentKey = $(this).attr('data-payment-key');
						const paymentCompletedNo = $(this).attr('data-payment-completed-no');
						const entCeoNo = $(this).attr('data-ent-ceo-no');
						const entEmpId = $(this).attr('data-ent-emp-id');

						Swal.fire({
							title: "환불 요청",
							input: "text",
							inputLabel: "환불 사유를 입력해주세요.",
							inputPlaceholder: "예: 단순변심, 상품 불량 등",
							showCancelButton: true,
							confirmButtonText: "환불 요청",
							cancelButtonText: "취소",
							inputValidator: (value) => {
								if (!value) {
									return "환불 사유는 필수입니다.";
								}
							}
						}).then((result) => {
							if (result.isConfirmed) {
								const refundReason = result.value;
								
								fetch('/customer/payment/refund', {
									method: 'POST',
									headers: {
										'Content-Type': 'application/x-www-form-urlencoded'
									},
									body: new URLSearchParams({
										orderId: orderId,
										paymentKey: paymentKey,
										paymentCompletedNo: paymentCompletedNo,
										refundReason: refundReason,
										entCeoNo: entCeoNo,
										entEmpId: entEmpId
									})
								})
								.then(async res => {
									const text = await res.text();
									if (res.ok) {
										Swal.fire("완료", text, "success").then(() => {
											location.reload();
										});
									} else {
										Swal.fire("실패", text, "error");
									}
								})
								.catch(err => {
									console.error("에러:", err);
									Swal.fire("오류", "환불 처리 중 문제가 발생했습니다.", "error");
								});
							}
						});
					
					} else {			        		
						Swal.fire("환불 불가", "배송완료가 아닌 상품은 환불할 수 없습니다.", "info");
						return;
					}
				});
				
				
				
				$('.detailBtn').click(function(e){
					e.preventDefault();
					
					const contractNo = $(this).closest('.product-cart-wrap').find('input[type="hidden"]').val();
					
					if(contractNo === '일시불판매'){
						Swal.fire("", "정기결제 상품이 아닙니다.", "error");
					} else{
						window.location.href = '/customer/payment/detail?rentalContractNo=' + contractNo;
					}
					
				});
				
				
				
				
				
				
				
			});
			
				
				

				
					


		</script>
	</th:block>
	
	<!-- 페이지 삽입공간 -->
	<th:block layout:fragment="customContents">
		<div>
			<h2 class="text-center mb-10" th:text="${title}"></h2>
		</div>
		<div class="overflow-auto" style="height: 800px;">
			<div class="product-list mb-50">
				<input type="hidden" id="custId" th:value="${custId}">
					<th:block th:if="${!#lists.isEmpty(paymentList)}" th:each="l : ${paymentList}">
						<!-- 상품1 -->
						<div class="product-cart-wrap border col-12" style="box-shadow:0 6px 12px 0 rgba(0,0,0,.04);">
							<div class="product-content-wrap mt-50 mb-30 col-7">
								<span class="payStatus" th:text="${l.requestStatus == '환불거부' ? '환불거부' : l.paymentStatus}">상태</span>
								<h4><a href="#" class="detailBtn" th:text="${l.prodNm}">상품명</a></h4>
								<div>
									<span th:text="|₩${#numbers.formatInteger(l.totalPrice, 3, 'COMMA')}|" style="color: black; font-size: 20px;">금액</span>
								</div>
								<div>
									<span th:text="${#strings.contains(l.rentalContractNo, 'rental') ? '렌탈' : (l.rentalContractNo == '일시불판매' ? '일반판매' : l.rentalContractNo)}" style="color: black;">계약정보</span>
									<input type="hidden" class="contractNo" th:value="${l.rentalContractNo}">
									<span style="color: black;">|</span>
									<span th:text="${l.paymentCompletedDate}" style="color: black;">계약날짜</span>
								</div>
								<div>
									<span class="delProgress" th:text="${#strings.isEmpty(l.delProgress) ? '주문취소' : l.delProgress}">배송상태</span>
								</div>
								
							</div>
							<div class="product-price d-flex col-5">
								<div class="ml-100 text-center">
									<p style="font-weight:bold; color: black;font-size: 25px; padding-right: 10px;"></p>
									<button type="button" class="btn cancelBtn" th:data-order-id="${l.orderId}" th:disabled="${l.paymentStatus == '주문취소'}" th:data-payment-completed-no="${l.paymentCompletedNo}">주문 취소</button>
									<button type="button" class="btn modifyCardBtn" th:if="${l.rentalContractNo != '일시불판매'}" th:disabled="${l.paymentStatus == '주문취소'}">카드 변경</button>
									<button type="button" class="btn refundBtn" th:if="${l.rentalContractNo == '일시불판매'}" 
											th:disabled="${l.requestStatus == '입점업체검토중' or l.requestStatus == '환불승인' or l.requestStatus == '환불거부'}" th:data-payment-key="${l.paymentKey}"
											th:data-order-id="${l.orderId}" th:data-payment-completed-no="${l.paymentCompletedNo}" 	
											th:data-ent-ceo-no="${l.entCeoNo}" th:data-ent-emp-id="${l.entEmpId}">상품 환불</button>
								</div>
							</div>
						</div>
					</th:block>
					<th:block th:unless="${!#lists.isEmpty(paymentList)}">
						<div class="product-cart-wrap border col-12 justify-content-center" style="box-shadow:0 6px 12px 0 rgba(0,0,0,.04);">
							<span class="mt-100 mb-100" style="color: black; font-size: 26px;">주문 내역이 없습니다.</span>
						</div>
					</th:block>
			</div>
		</div>
	</th:block> 
</html>