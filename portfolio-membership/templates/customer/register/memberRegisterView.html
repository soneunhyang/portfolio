<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{customer/layout/default}">

	<!-- head 삽입공간 -->
	<head>
	</head>
	
	<th:block layout:fragment="jsFile">
	
	</th:block>
	
	<!-- 페이지 삽입공간 -->
	<th:block layout:fragment="customContents">
        <div class="page-content pt-150 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-xl-8 col-lg-10 col-md-12 m-auto">
                        <div class="row justify-content-center">
                            <div class="col-lg-6 col-md-8">
                                <div class="login_wrap widget-taber-content background-white">
                                    <div class="padding_eight_all bg-white">
                                        <div class="heading_s1">
                                            <h1 class="mb-5" th:text="${title}"></h1>
                                            <p class="mb-30">이미 회원이신가요? <a th:href="@{/customer/login/memberLogin}">로그인</a></p>
                                        </div>
                                        <form id="memberRegisterForm" th:action="@{/customer/register/memberRegister}" method="post"> 
                                        	 <!-- 아이디 입력 및 중복 확인 -->                                        
                                            <div class="form-group d-flex">
                                            	<input type="hidden" id="isIdChecked" value="false" />
                                                <input type="text" id="memberId" name="memberId" placeholder="아이디(6-12자 이내, 영문/숫자 사용 가능)" value="corpcustid5" required />
                                                <button type="button" id="idCheckBtn" class="btn btn-heading btn-block p-10 ml-10" style="width:20%">중복확인</button>
                                            </div>     
                                            <!-- 비밀번호 입력 -->      
                                            <div class="form-group">
	                                        	<input type="password" id="memberPw" name="memberPw" placeholder="비밀번호(8자 이상, 특수문자 포함)" readonly required />
												<small id="pwFeedback" style="color:red;"></small>
                                            </div>
                                            <div class="form-group">
                                                <input type="password" id="memberPwConfirm" name="memberPwConfirm" placeholder="비밀번호 확인" readonly required />
                                                <span id="passwordMatchMessage"></span>
                                            </div>
                                        	<!-- 회원 유형 선택 -->
                                            <div class="custome-radio type-radio d-flex justify-content-evenly mb-30">
                                                <div class="custome-radio">
												    <input class="form-check-input" type="radio" id="memberTypeCustomer" name="memberType" value="customer" checked="checked" required />
												    <label class="form-check-label" for="memberTypeCustomer">일반/기업회원</label>
												</div>
												<div class="custome-radio">
												    <input class="form-check-input" type="radio" id="memberTypeEnt" name="memberType" value="입점업체 대표" required />
												    <label class="form-check-label" for="memberTypeEnt">입점업체</label>
												</div>
                                            </div>
                                            <!-- 약관 동의 -->
                                            <div class="login_footer form-group justify-content-end">
                                                <div class="chek-form">
                                                    <div class="custome-checkbox">
                                                        <input class="form-check-input" type="checkbox" id="agreeCheckbox" name="agreeCheckbox"  value="agree" required />
                                                        <label class="form-check-label mr-10" for="agreeCheckbox"><span>약관 동의</span></label>
                                                    </div>
                                                </div>
                                                <a th:href="@{#}"><i class="fi-rs-book-alt mr-5 text-muted"></i>자세히 보기</a>
                                            </div>
                                            <!-- 다음 버튼 -->
                                            <div class="form-group">
                                                <button type="submit" id="goNextBtn" name="goNextBtn" class="btn btn-heading btn-block hover-up">다음</button>
                                            </div>
                                            <p class="font-xs text-muted"><strong>참고:</strong>귀하의 개인 데이터는 이 웹사이트 전체에서 귀하의 경험을 지원하고, 귀하의 계정에 대한 액세스를 관리하고, 당사의 개인 정보 보호 정책에 설명된 기타 목적을 위해 사용됩니다.</p>
                                        </form>
                                    </div>
                                </div> 
                            </div>
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>
	</th:block>
	<th:block layout:fragment="jsScript">
		<script>
			/**
			 * 아이디 중복체크
			 */
			$('#idCheckBtn').click(function() {
			    let memberId = $('#memberId').val().trim();
			
				if(!memberId){
					alert('아이디를 입력해주세요');
					$('#memberId').focus();
					return;
				}
				
				// 공백 포함된 아이디
			    if (memberId.includes(' ')) {
			        alert('아이디에는 공백을 사용할 수 없습니다.');
			        $('#memberId').focus();
			        return;
			    }
			    
				
				const request = $.ajax({
					url : '/customer/register/idCheck',
					method : 'post',
					data : {'memberId' : memberId},
					dataType : 'json'
				});
				
				request.done(isDuplicate => {
					
					if(isDuplicate){
						alert('사용할 수 없는 아이디입니다. 다른 아이디를 입력해주세요');
						$('#memberId').focus();
						return;
					}
					
					alert('사용가능한 아이디 입니다.');
					$('#isIdChecked').val('true');
					// 중복되지 않은 경우 비밀번호 필드 활성화
					$('#memberPw, #memberPwConfirm').prop('readonly', false);
					$('#memberPw').focus();
				});
				
				request.fail((jqXHR, textStatus, error)=>{
					console.log(jqXHR, textStatus, error);
				});
				
			});
			
			/**
			 * 비밀번호 유효성 + 일치 여부 통합 검사
			 */
			 function validatePasswords(){
				    const $pw = $('#memberPw'),
				          $cf = $('#memberPwConfirm'),
				          $msg = $('#passwordMatchMessage');
				   
			        const pw = $pw.val();
			        const cf = $cf.val();
			        const valid = /^(?=.*[!@#$%^&*()_+~`{}\[\]:;"'<>,.?\/\\|\-]).{8,}$/;

			        // 유효성 검사 실패
			        if (!valid.test(pw)) {
			            $msg.text('8자 이상, 특수문자 포함 필수').css('color', 'red');
			            $pw.css('border-color', 'red');
			            $cf.css('border-color', '');
			            return false;
			        }

			        // 유효성 통과 + 일치하지 않음
			        if (cf && pw !== cf) {
			            $msg.text('비밀번호가 일치하지 않습니다.').css('color', 'red');
			            $pw.css('border-color', 'green');
			            $cf.css('border-color', 'red');
			            return false;
			        }

			        // 유효성 통과 + 일치함
			        if (cf && pw === cf) {
			            $msg.text('비밀번호가 유효하며 일치합니다.').css('color', 'green');
			            $pw.css('border-color', 'green');
			            $cf.css('border-color', 'green');
			            return true;
			        }

			        // 유효성 통과 (확인 입력 전)
			        $msg.text('');
			        $pw.css('border-color', 'green');
			        $cf.css('border-color', '');
			        return false;
			    }
			
			 /**
			  * 비밀번호 입력할 때 마다 유효성검증
			  */
			 $(function () {
				    $('#memberPw, #memberPwConfirm').on('input', validatePasswords);
				});
			 
			
			/**
			 * 회원등록 폼 유효성 검증 및 페이지 이동 
			 */
			$(document).ready(function () {
				
			    $('#memberId').on('input', function () {
			        $('#isIdChecked').val('false');
			    });
		 
				$('#goNextBtn').click((e) => {
				    e.preventDefault();
				    
				    // 아이디 중복확인
				    if ($('#isIdChecked').val() !== 'true') {
				        alert('아이디 중복확인을 해주세요.');
				        $('#memberId').focus();
				        return;
				    }
				    
				    // 비밀번호 유효성 검증 확인
				    if (!validatePasswords()) {
				        alert('비밀번호를 다시 확인해주세요.');
				        return;
				    }
				    
				    const $formTag = $('#memberRegisterForm').find('input, select');
				    
				    let isSubmit = true;
				    
				    $formTag.each((idx, element) => {
				        const value = $(element).val();
				        
				        // 체크박스 필드
				        if ($(element).is('input[type="checkbox"]') && !$(element).is(':checked')) {
				            alert('약관에 동의해 주세요.');
				            $(element).focus();
				            isSubmit = false;
				            return false;
				        }
				        
				        // 일반 input 필드
				        if (!value.trim() && !$(element).is('input[type="checkbox"]')) {
				            const placeholder = $(element).attr('placeholder');
				            alert(`${placeholder} 필수 입력항목입니다.`);
				            $(element).focus();
				            isSubmit = false;
				            return false;
				        }
				    });
							   
				    if (isSubmit) {
				        $('#memberRegisterForm').submit();
				    }
				
				});
			});
		</script>
	</th:block>
	
</html>